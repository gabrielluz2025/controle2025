<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Controle Financeiro Pessoal Completo</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/xlsx/dist/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        /* (Estilos mantidos conforme original) */
        /* ... */
        /* (Para economizar espaço na resposta, mantenha todos os estilos originais aqui) */
    </style>
</head>
<body class="p-4 sm:p-6 md:p-8 lg:p-10">
    <div class="max-w-5xl mx-auto bg-white rounded-xl shadow-lg p-6 sm:p-8">
        <!-- ... todo o conteúdo HTML original, sem alterações visuais ... -->

        <!-- Adicione a seção de backup após o botão de baixar Excel -->
        <div class="mb-8 border-b pb-6 border-gray-200">
            <h2 class="text-2xl font-semibold text-gray-700 mb-4">Backup dos Dados</h2>
            <button id="export-backup-btn" class="w-full sm:w-auto px-6 py-2 bg-indigo-600 text-white font-semibold rounded-md shadow-md hover:bg-indigo-700">Exportar Backup (.json)</button>
            <input type="file" id="import-backup-input" accept=".json" class="mt-4"/>
        </div>

        <!-- ... resto do HTML original ... -->
    </div>

    <script>
        // --- Função para escapar HTML (SEGURANÇA) ---
        function escapeHtml(text) {
            if (typeof text !== 'string') return text;
            return text.replace(/[&<>"']/g, function(m) {
                return ({
                    '&': '&amp;',
                    '<': '&lt;',
                    '>': '&gt;',
                    '"': '&quot;',
                    "'": '&#39;'
                })[m];
            });
        }

        // --- Alerta de concorrência (várias abas) ---
        window.addEventListener('storage', function(e) {
            if (
                e.key === 'financialTransactions' ||
                e.key === 'financialAccounts' ||
                e.key === 'financialCreditCards' ||
                e.key === 'financialCategories'
            ) {
                showFeedback('Os dados foram alterados em outra aba. Recarregue a página para evitar conflitos.', 'info');
            }
        });

        // (Coloque todas as variáveis globais e funções originais aqui, igual seu arquivo)

        // Exemplo de uso de escapeHtml ao renderizar valores vindos do usuário:
        // No renderTransactions:
        // ...
        // <td>${escapeHtml(transaction.description)}</td>
        // <td>${escapeHtml(transaction.category)}</td>
        // ...

        // Exemplo de validação extra no submit do formulário de transação:
        transactionForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const date = document.getElementById('date').value;
            const description = document.getElementById('description').value.trim();
            const value = parseFloat(document.getElementById('value').value);
            // ... resto do código ...

            if (value <= 0) {
                showFeedback('O valor deve ser maior que zero.', 'error');
                return;
            }
            if (!date || isNaN(new Date(date).getTime())) {
                showFeedback('Data inválida.', 'error');
                return;
            }
            // ... resto do código do evento submit ...
        });

        // Após atualizar o limite do cartão:
        // Por exemplo, sempre que fizer:
        // creditCard.availableLimit -= valor;
        // Adicione logo em seguida:
        // creditCard.availableLimit = Math.max(0, creditCard.availableLimit);

        // --- Exportar backup JSON ---
        document.getElementById('export-backup-btn').onclick = function() {
            const backup = {
                contas: localStorage.getItem('financialAccounts'),
                cartoes: localStorage.getItem('financialCreditCards'),
                transacoes: localStorage.getItem('financialTransactions'),
                categorias: localStorage.getItem('financialCategories')
            };
            const blob = new Blob([JSON.stringify(backup, null, 2)], { type: "application/json" });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'backup_financeiro.json';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
        };

        // --- Importar backup JSON ---
        document.getElementById('import-backup-input').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = function(evt) {
                try {
                    const data = JSON.parse(evt.target.result);
                    if (data.contas) localStorage.setItem('financialAccounts', data.contas);
                    if (data.cartoes) localStorage.setItem('financialCreditCards', data.cartoes);
                    if (data.transacoes) localStorage.setItem('financialTransactions', data.transacoes);
                    if (data.categorias) localStorage.setItem('financialCategories', data.categorias);
                    showFeedback('Backup importado com sucesso! Recarregue a página.', 'success');
                } catch {
                    showFeedback('Arquivo de backup inválido.', 'error');
                }
            };
            reader.readAsText(file);
        });

        // --- O RESTANTE DO SEU CÓDIGO ORIGINAL, com as adaptações mostradas acima ---
        // (Não esqueça de aplicar escapeHtml ao exibir dados do usuário e Math.max(0, ...) ao atualizar limites do cartão)
    </script>
</body>
</html>
